<div class="activity-detail-page">
  <!-- Loading -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Učitavanje...</p>
  </div>

  <!-- Error -->
  <div class="error-container" *ngIf="error">
    <p>{{ error }}</p>
    <a routerLink="/home" class="btn-back">Nazad na početnu</a>
  </div>

  <!-- Content -->
  <div class="content" *ngIf="activity && !isLoading">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a routerLink="/home">Početna</a>
      <span class="separator">›</span>
      <a routerLink="/activities">Aktivnosti</a>
      <span class="separator">›</span>
      <span class="current">{{ activity.name }}</span>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <!-- Left side -->
      <div class="left-column">
        <!-- Header -->
        <div class="activity-header">
          <span class="category-badge">{{ activity.category }}</span>
          <h1>{{ activity.name }}</h1>
          <div class="institution-info">
            <span class="by">by</span>
            <a class="institution-name">{{ activity.institution.name }}</a>
          </div>
        </div>

        <!-- Image -->
        <div class="image-container">
          <img [src]="getImageUrl()" [alt]="activity.name" />
        </div>

        <!-- Institution card -->
        <div class="institution-card">
          <div class="institution-avatar">
            {{ activity.institution.name.charAt(0).toUpperCase() }}
          </div>
          <div class="institution-details">
            <h3>{{ activity.institution.name }}</h3>
            <p>{{ activity.institution.email }}</p>
          </div>
        </div>

        <!-- Description -->
        <div class="section">
          <h2>O aktivnosti</h2>
          <p class="description">{{ activity.description }}</p>
        </div>

        <!-- Reviews section placeholder -->
        <div class="section">
          <h2>Recenzije</h2>
          <p class="no-reviews">Još uvek nema recenzija za ovu aktivnost.</p>
        </div>
      </div>

      <!-- Right side - Booking card -->
      <div class="right-column">
        <div class="booking-card">
          <!-- Age & Rating -->
          <div class="booking-info">
            <div class="info-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span>Uzrast: {{ activity.age_from }} - {{ activity.age_to }} god.</span>
            </div>

            <div class="info-item" *ngIf="getNextAvailableDate()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <span>{{ getNextAvailableDate() }}</span>
              <a class="more-link" *ngIf="activity.time_slots.length > 1">+ još termina</a>
            </div>

            <div class="info-item" *ngIf="getUniqueLocations().length > 0">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span>{{ getUniqueLocations()[0] }}</span>
              <a class="more-link" *ngIf="getUniqueLocations().length > 1">+ još lokacija</a>
            </div>
          </div>

          <!-- Price -->
          <div class="price-section">
            <span class="price">{{ activity.price | number : '1.0-0' }} RSD</span>
            <span class="price-label">po terminu</span>
          </div>

          <!-- Slots -->
          <div class="slots-section" *ngIf="activity.time_slots && activity.time_slots.length > 0">
            <h3>Izaberite termin</h3>
            <div class="slots-list">
              <div
                class="slot-item"
                *ngFor="let slot of activity.time_slots"
                [class.selected]="selectedSlot?.id === slot.id"
                [class.full]="getAvailableSpots(slot) === 0"
                (click)="getAvailableSpots(slot) > 0 && selectSlot(slot)"
              >
                <div class="slot-date">{{ formatDate(slot.date) }}</div>
                <div class="slot-time">
                  {{ formatTime(slot.time_from) }} - {{ formatTime(slot.time_to) }}
                </div>
                <div class="slot-location">{{ slot.location.city }}</div>
                <div class="slot-spots" [class.low]="getAvailableSpots(slot) <= 3">
                  {{ getAvailableSpots(slot) }}
                  {{ getAvailableSpots(slot) === 1 ? 'mesto' : 'mesta' }}
                </div>
              </div>
            </div>
          </div>

          <div class="no-slots" *ngIf="!activity.time_slots || activity.time_slots.length === 0">
            <p>Trenutno nema dostupnih termina.</p>
          </div>

          <!-- CTA Button -->
          <button
            class="btn-book"
            [disabled]="!selectedSlot"
            *ngIf="authService.isLoggedIn() && authService.isParent()"
            (click)="openReservationModal()"
          >
            Rezerviši termin
          </button>

          <a routerLink="/login" class="btn-book" *ngIf="!authService.isLoggedIn()">
            Prijavi se za rezervaciju
          </a>

          <p class="login-hint" *ngIf="!authService.isLoggedIn()">
            Morate biti prijavljeni da biste rezervisali termin
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- RESERVATION MODAL -->
  <div class="modal-overlay" *ngIf="showReservationModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- Success state -->
      <div class="modal-success" *ngIf="reservationSuccess">
        <div class="success-icon">✓</div>
        <h2>Rezervacija uspešna!</h2>
        <p>Vaša rezervacija je poslata. Ustanova će je uskoro pregledati.</p>
        <button class="btn-primary" (click)="closeModal()">Zatvori</button>
      </div>

      <!-- Form state -->
      <div class="modal-form" *ngIf="!reservationSuccess">
        <div class="modal-header">
          <h2>Rezervacija termina</h2>
          <button class="btn-close" (click)="closeModal()">&times;</button>
        </div>

        <!-- Selected slot info -->
        <div class="selected-slot-info" *ngIf="selectedSlot">
          <h3>{{ activity?.name }}</h3>
          <p>
            <strong>Termin:</strong> {{ formatDate(selectedSlot.date) }},
            {{ formatTime(selectedSlot.time_from) }} - {{ formatTime(selectedSlot.time_to) }}
          </p>
          <p>
            <strong>Lokacija:</strong> {{ selectedSlot.location.city }},
            {{ selectedSlot.location.address }}
          </p>
          <p><strong>Cena:</strong> {{ activity?.price | number : '1.0-0' }} RSD</p>
        </div>

        <!-- Child selection -->
        <div class="form-group">
          <label>Izaberite dete:</label>

          <div class="no-children" *ngIf="children.length === 0">
            <p>Nemate dodatu decu. Molimo prvo dodajte dete.</p>
            <a routerLink="/my-children" class="btn-secondary">Dodaj dete</a>
          </div>

          <div
            class="no-eligible"
            *ngIf="children.length > 0 && getEligibleChildren().length === 0"
          >
            <p>
              Nijedno vaše dete ne odgovara uzrastu za ovu aktivnost ({{ activity?.age_from }} -
              {{ activity?.age_to }} god.).
            </p>
          </div>

          <div class="children-list" *ngIf="getEligibleChildren().length > 0">
            <div
              class="child-option"
              *ngFor="let child of getEligibleChildren()"
              [class.selected]="selectedChildId === child.id"
              (click)="selectedChildId = child.id"
            >
              <div class="child-avatar">{{ child.first_name.charAt(0) }}</div>
              <div class="child-info">
                <span class="child-name">{{ child.first_name }} {{ child.last_name }}</span>
                <span class="child-age">{{ child.age }} godina</span>
              </div>
              <div class="check-mark" *ngIf="selectedChildId === child.id">✓</div>
            </div>
          </div>
        </div>

        <!-- Note -->
        <div class="form-group" *ngIf="getEligibleChildren().length > 0">
          <label for="note">Napomena (opciono):</label>
          <textarea
            id="note"
            [(ngModel)]="reservationNote"
            placeholder="Npr. alergije, posebne potrebe..."
            rows="3"
          ></textarea>
        </div>

        <!-- Error message -->
        <div class="error-message" *ngIf="reservationError">
          {{ reservationError }}
        </div>

        <!-- Actions -->
        <div class="modal-actions" *ngIf="getEligibleChildren().length > 0">
          <button class="btn-secondary" (click)="closeModal()">Otkaži</button>
          <button
            class="btn-primary"
            [disabled]="!selectedChildId || isSubmitting"
            (click)="submitReservation()"
          >
            {{ isSubmitting ? 'Slanje...' : 'Potvrdi rezervaciju' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
